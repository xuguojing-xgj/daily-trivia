# TCP 三次握手与四次挥手

### 当从浏览器输入一个 url 后，发生了什么？

1. 浏览器会向 `DNS` 服务器请求解析该 `URL` 信息，`DNS` 服务器会在本地缓存中查找，如果没有则会询问根域名服务器进行解析(访问)

   - 其实就是一个逐渐向根域名服务器(`缓存中`)查找(`解析`)的过程
   - 依次为: `.com` 顶级域名服务器, `google` 的域名服务器, `google` 的 IP 地址

2. 根域名服务器会在其缓存中查找，如果没有会返回 google 的 IP 地址给本地 DNS 服务器，再由它返回

3. 本地 DNS 服务器会把 google 的 IP 地址返回给浏览器，再由它返回

4. 浏览器会通过 IP 地址向服务器发起 TCP 三次握手，建立连接

5. 浏览器向服务器发送 HTTP 请求，请求报文会先经过浏览器缓存处理，再通过 TCP 三次握手建立连接，

6. 服务器收到请求后，会返回 HTTP 响应，响应报文也会先经过服务器缓存处理，再通过 TCP 四次 挥手断开连接

7. 浏览器收到响应后，会进行渲染，展示给用户

### TCP 三次握手和四次挥手

握手(创建 TCP 连接) <br />

一次

- 客户端向服务器发送一个 `SYN` 报文(包)，(带有一个随机的序号 X) 告诉服务器客户端要打开到服务器的连接

两次

- 服务器收到后，会返回一个 `SYN + ACK` 报文(包), 该包是一个新的随机数 Y, 并确认号为 X+1, 既确认接收到客户端的 `SYN`
  并发送到自己的 `SYN` , 告诉客户端，服务器收到了你的请求，并同意建立连接

三次

- 客户端收到后，会想服务器发送一个 `ACK` 报文(包), 设序列号为 X+1, 确认号为 Y+1, 告诉服务器, 客户端收到了服务器的`SYN`

挥手(断开 TCP 连接) <br />

一次

- 主动关闭连接的一方(假设是客户端)完成数据发送后 它发送一个 `FIN` 报文的包(序列号 U), 告诉对方，我要断开连接了

两次

- 服务器收到后，会返回一个 `ACK` 报文的包, 确认号为(U+1), 告诉客户端，我已经收到了你的 `FIN` 报文

三次

- 服务器在确认发送完所有数据后, 也发送一个`FIN` 报文的包(序列号 V) 告诉客户端，我已经收到了你的 `ACK` 报文, 表示也已经准备好关闭连接了

四次

- 客户端确认收到 `FIN`包后, 回应一个 `ACK` 报文(确认号为 V+1), 然后等待 2MSL (最长报文段寿命) 后, 在呼叫内核删除对应的连接对象, 这是防止最后的 `ACK` 丢失 然后关闭连接
